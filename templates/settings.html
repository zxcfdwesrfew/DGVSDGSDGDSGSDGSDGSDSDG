{% extends "navbar.html" %}

{% block top %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Settings</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background:#060606; color:#e5e5e5; font-family:'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin:0; }
        .settings-shell { max-width:1000px; margin:28px auto 80px; padding:0 20px; box-sizing:border-box; }
        .settings-card { background:#060606; border:1px solid #222; padding:22px 24px 26px; box-shadow:none; }
        .section-title { font-size:17px; font-weight:600; margin:0 0 18px 0; color:#fff; }
        .form-row { display:flex; flex-direction:column; align-items:flex-start; gap:8px; margin-bottom:16px; }
        .form-row label { font-weight:500; color:#dcdcdc; font-size:14px; }
        .field { width:100%; display:flex; flex-direction:column; gap:8px; }
        .form-control, textarea, input[type="file"], select { width:100%; background:#0f0f0f; border:1px solid #2a2a2a; color:#e5e5e5; padding:8px 10px; border-radius:0; font-size:14px; box-sizing:border-box; height:36px; }
        textarea { resize:vertical; min-height:44px; height:44px; }
        .preview { width:100%; max-height:160px; object-fit:cover; border:1px solid #333; margin-bottom:6px; }
        .remove-btn { border:1px solid #b21c1c; color:#b21c1c; background:#120000; padding:6px 10px; border-radius:0; font-size:13px; width:140px; }
        .remove-btn:hover { background:#2a0000; color:#fff; }
        .swatches { display:grid; grid-template-columns:repeat(12, 18px); gap:6px; }
        .swatch { width:18px; height:18px; border:1px solid #333; cursor:pointer; padding:0; }
        .swatch input { display:none; }
        .swatch.checked { outline:1px solid #fff; outline-offset:1px; box-shadow:0 0 0 1px #000 inset; }
        .inline { display:flex; align-items:center; gap:10px; }
        .muted { color:#777; font-size:13px; }
        .btn-primary { background:#111; border:1px solid #333; color:#e5e5e5; padding:10px 16px; border-radius:0; min-width:140px; cursor:pointer; }
        .btn-primary:hover { background:#1b1b1b; }
        .twofa-box { display:flex; flex-direction:column; gap:8px; }
        input[type="checkbox"] { width:16px; height:16px; accent-color:#e5e5e5; }
        .badge-row { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid #161616; width:100%; }
        .badge-row:last-child { border-bottom:none; }
        .badge-thumb { width:32px; height:32px; border-radius:50%; background:#0b0b0b; border:1px solid #222; display:flex; align-items:center; justify-content:center; }
        .badge-thumb img { width:18px; height:18px; object-fit:contain; opacity:0.85; filter:grayscale(100%); }
        .badge-name { color:#ddd; font-weight:600; font-size:13px; }
    </style>
</head>
<body>
{% endblock %}

{% block bottom %}
<div class="settings-shell">
    <div class="settings-card">
        <h2 class="section-title">Settings</h2>
        {% if error %}<div class="alert alert-danger" style="background:#1a0000;border:1px solid #3a0000;color:#ffb3b3;padding:10px 12px;margin-bottom:14px;border-radius:2px;">{{ error }}</div>{% endif %}
        <form method="post" enctype="multipart/form-data" id="settings-form">
            {% if top_role and ROLE_LEVELS.get(top_role, 0) >= ROLE_LEVELS['rich'] %}
            <div class="form-row">
                <label>Background</label>
                <div class="field">
                    {% if profile['background_path'] %}
                        <img class="preview" src="{{ profile['background_path'] }}" alt="background">
                        <button type="button" class="remove-btn" onclick="document.getElementById('remove-background-form').submit()">Remove</button>
                    {% else %}
                        <input type="file" name="background">
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="form-row">
                <label>Banner</label>
                <div class="field">
                    {% if profile['banner_path'] %}
                        <img class="preview" src="{{ profile['banner_path'] }}" alt="banner">
                        <button type="button" class="remove-btn" onclick="document.getElementById('remove-banner-form').submit()">Remove</button>
                    {% else %}
                        <input type="file" name="banner">
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <label>Avatar</label>
                <div class="field">
                    {% if profile['avatar_path'] %}
                        <img class="preview" style="max-width:140px;" src="{{ profile['avatar_path'] }}" alt="avatar">
                        <button type="button" class="remove-btn" onclick="document.getElementById('remove-avatar-form').submit()">Remove</button>
                    {% else %}
                        <input type="file" name="avatar">
                    {% endif %}
                </div>
            </div>

            {% if top_role and ROLE_LEVELS.get(top_role, 0) >= ROLE_LEVELS['founder'] %}
            <div class="form-row">
                <label>Profile music (mp3, max 5 MB)</label>
                <div class="field">
                    {% if profile.get('music_path') %}
                        <audio controls style="width:100%;max-width:320px;" src="{{ profile['music_path'] }}"></audio>
                        <button type="button" class="remove-btn" onclick="document.getElementById('remove-music-form').submit()">Remove</button>
                    {% endif %}
                    <input type="file" name="music" accept="audio/mpeg">
                </div>
            </div>
            {% endif %}

            <div class="form-row">
                <label>Username</label>
                <div class="field">
                    <input class="form-control" value="{{ user['username'] }}" disabled>
                </div>
            </div>

            <div class="form-row">
                <label>Bio</label>
                <div class="field">
                    <textarea name="bio" class="form-control" rows="2">{{ profile['bio'] or '' }}</textarea>
                </div>
            </div>

            {% if top_role and ROLE_LEVELS.get(top_role, 0) >= ROLE_LEVELS['rich'] %}
            <div class="form-row">
                <label>Username Color</label>
                <div class="field">
                    <div class="swatches">
                        {% set palette = ['#FFD700','#000000','#444444','#888888','#bfbfbf','#ffffff','#f5a9b8','#e75480','#f39c12','#d35400','#8a2be2','#2980b9','#3498db','#1abc9c','#27ae60','#16a085','#e74c3c','#9b59b6','#34495e','#2c3e50','#95a5a6','#d35400','#7f8c8d','#2ecc71','#c0392b'] %}
                        {% for c in palette %}
                        {% set checked = (profile['username_color']==c) or (not profile['username_color'] and c=='#FFD700') %}
                        <label class="swatch {% if checked %}checked{% endif %}" style="background: {{ c }};">
                            <input type="radio" name="username_color" value="{{ c }}" {% if checked %}checked{% endif %}>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <input type="hidden" name="username_color" value="{{ profile['username_color'] or '#FFD700' }}">
            {% endif %}

            <div class="form-row">
                <label>Comments in your profile</label>
                <div class="field inline">
                    <input type="checkbox" name="allow_comments" {% if profile['allow_profile_comments'] %}checked{% endif %}>
                    <span>Allow comments</span>
                </div>
            </div>

            {% if top_role and ROLE_LEVELS.get(top_role, 0) >= ROLE_LEVELS['rich'] %}
            <div class="form-row">
                <label>Bio animation</label>
                <div class="field">
                    <select name="bio_animation_type">
                        <option value="" {% if not profile['bio_animation_type'] %}selected{% endif %}>None</option>
                        <option value="typewriter" {% if profile['bio_animation_type']=='typewriter' %}selected{% endif %}>Typewriter</option>
                    </select>
                </div>
            </div>
            {% else %}
            <input type="hidden" name="bio_animation_type" value="{{ profile['bio_animation_type'] or '' }}">
            {% endif %}

            <div class="form-row">
                <label>Name effect</label>
                <div class="field">
                    {% if top_role == 'rich' %}
                        <select disabled>
                            <option selected>Gold (Rich default)</option>
                        </select>
                        <input type="hidden" name="name_effect" value="gold">
                    {% elif top_role and top_role not in ['user','vip'] %}
                        <select name="name_effect">
                            {% for key, path in effects.items() %}
                            <option value="{{ key }}" {% if profile['name_effect']==key %}selected{% endif %}>{{ key|replace('-', ' ')|capitalize }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <select disabled>
                            <option selected>Effects available for Rich+</option>
                        </select>
                        <input type="hidden" name="name_effect" value="">
                    {% endif %}
                </div>
            </div>
            {% if top_role and ROLE_LEVELS.get(top_role, 0) >= ROLE_LEVELS['rich'] %}
            <div class="form-row">
                <label>Glow</label>
                <div class="field inline">
                    <input type="checkbox" name="glow_enabled" {% if profile.get('glow_enabled') %}checked{% endif %}>
                    <span>Enable glow on nickname/role (default off)</span>
                </div>
            </div>
            {% endif %}

            {% if badges %}
            <div class="form-row">
                <label>Badge colors</label>
                <div class="field" style="gap:12px;">
                    {% for b in badges %}
                    <div class="badge-row">
                        <div class="badge-thumb" style="background: {{ b['color'] or '#0b0b0b' }};">
                            {% if b['icon'] %}
                                <img draggable="false" src="{{ b['icon'] }}">
                            {% else %}
                                <span style="color:#fff;">*</span>
                            {% endif %}
                        </div>
                        <div class="badge-name">{{ b['name'] }}</div>
                        <input class="form-control" type="text" name="badge_color_{{ b['id'] }}" value="{{ b['color'] or '#0b0b0b' }}" style="max-width:120px;">
                        <span class="muted">Enter hex (#RRGGBB)</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="form-row">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            </div>

            <div class="form-row">
                <label>Active Sessions</label>
                <div class="field" style="flex-direction:column; gap:12px;">
                    {% if sessions_list %}
                        {% for s in sessions_list %}
                        <div style="background:#0b0b0b;border:1px solid #1c1c1c;border-radius:10px;padding:12px 14px;display:flex;flex-direction:column;gap:6px;">
                            <div style="display:flex;align-items:center;gap:8px;color:#89a9ff;font-weight:600;">
                                <span style="font-size:14px;">{{ s['ua'] or 'Unknown device' }}</span>
                                {% if current_ip and s['ip']==current_ip %}
                                    <span style="background:#1f2b4d;color:#9fc2ff;padding:2px 8px;border-radius:12px;font-size:11px;">Current</span>
                                {% endif %}
                            </div>
                            <div style="color:#888;font-size:12px;">
                                <div>IP: {{ s['ip'] or 'N/A' }}</div>
                                <div>Last active: {{ s['last_seen'] }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <span class="muted">No sessions recorded.</span>
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <label>Email</label>
                <div class="field">
                    <input class="form-control" name="email" placeholder="Email" value="{{ user['email'] or '' }}">
                </div>
            </div>

            <div class="form-row">
                <label>Current Password</label>
                <div class="field">
                    <input class="form-control" type="password" name="current_password" placeholder="Current Password">
                </div>
            </div>

            <div class="form-row">
                <label>New Password</label>
                <div class="field">
                    <input class="form-control" type="password" name="new_password" placeholder="New Password">
                </div>
            </div>

            <div class="form-row">
                <label>Two-Factor Auth</label>
                <div class="field">
                    {% if twofa and twofa['enabled'] %}
                        <div class="twofa-box">
                            <span class="muted">2FA is currently enabled.</span>
                            <button class="btn-primary" type="submit" name="action" value="disable_2fa">Disable 2FA</button>
                        </div>
                    {% else %}
                        <div class="twofa-box">
                            <div class="muted">Secret: <code>{{ new_secret }}</code></div>
                            <input type="hidden" name="secret" value="{{ new_secret }}">
                            <input class="form-control" name="otp" placeholder="Enter OTP">
                            <button class="btn-primary" type="submit" name="action" value="enable_2fa">Enable 2FA</button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div style="margin-top:20px; text-align:center;">
                <button type="submit" class="btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Hidden remove forms for background, banner, avatar -->
<form id="remove-background-form" method="post" action="{{ url_for('remove_media', kind='background') }}" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
</form>
<form id="remove-banner-form" method="post" action="{{ url_for('remove_media', kind='banner') }}" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
</form>
<form id="remove-avatar-form" method="post" action="{{ url_for('remove_media', kind='avatar') }}" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
</form>
<form id="remove-music-form" method="post" action="{{ url_for('remove_media', kind='music') }}" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
</form>

<script>
    document.querySelectorAll('.swatch input').forEach(function(input) {
        input.addEventListener('change', function() {
            document.querySelectorAll('.swatch').forEach(function(s){ s.classList.remove('checked'); });
            const parent = this.closest('.swatch');
            if (parent) parent.classList.add('checked');
        });
    });
</script>
</body>
</html>
{% endblock %}
