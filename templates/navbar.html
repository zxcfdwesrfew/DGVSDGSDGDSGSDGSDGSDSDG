{% block top %}{% endblock %}
<link rel="stylesheet" href="/static/nav.css">
<style>
.nav-badge{
    display:inline-block;
    margin-left:6px;
    padding:1px 6px;
    background:#d00;
    color:#fff;
    border-radius:8px;
    font-size:11px;
    line-height:1.2;
    vertical-align:middle;
}
</style>
<nav>
    <div class="container">
        <div class="nav-brand">
            <a href="{{ url_for('index') }}" id="site-name">Ghostbin</a>
            <div class="online-count mobile-only" id="online-mobile" style="display:none;">0</div>
        </div>
        <button class="navbar-toggler" type="button" onclick="toggleNav()">Menu</button>
        <div class="nav-wrapper" id="navWrapper">
            <ul class="nav-menu">
                <li><a href="{{ url_for('index') }}">Home</a></li>
                <li><a href="{{ url_for('new_paste') }}">Add Paste</a></li>
                <li><a href="{{ url_for('users') }}">Users</a></li>
                <li><a href="{{ url_for('upgrades') }}">Upgrades</a></li>
                <li><a href="{{ url_for('hall_of_loosers') }}">Hall of Autism</a></li>
                <li><a href="{{ url_for('tos') }}">Help</a></li>
                {% if user_can_see_council() %}
                <li><a href="{{ url_for('council_dashboard') }}">Council</a></li>
                {% endif %}
                {% if user_can_see_admin() %}
                <li>
                    <a href="{{ url_for('admin_dashboard') }}">
                        Admin
                        {% if nav_admin_total and nav_admin_total > 0 %}
                        <span class="nav-badge">{{ nav_admin_total }}</span>
                        {% endif %}
                    </a>
                </li>
                {% endif %}
            </ul>
            <div class="online-count desktop-only" id="online-desktop" style="display:none;">0</div>
            <div class="nav-auth">
                <button class="chat-toggle-btn" onclick="toggleChat()" style="margin-right: 16px; color: #2A9FD6; background: none; border: none; cursor: pointer; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;">Chat</button>
                {% if username %}
                <div class="notification-icon desktop-only">
                    <a href="{{ url_for('notifications') }}"><i class="fa-solid fa-bell"></i></a>
                    <span id="notification-count"></span>
                </div>
                <div class="desktop-only dropdown">
                    <button class="dropdown-toggle">
                        <span style="color:#2A9FD6;">{{ username }}</span>
                    </button>
                    <div class="dropdown-menu">
                        <a href="{{ url_for('user_profile', username=username) }}">Profile</a>
                        <a href="{{ url_for('settings') }}">Settings</a>
                        <a href="{{ url_for('logout') }}">Logout</a>
                    </div>
                </div>
                {% else %}
                <div class="auth-links">
                    <a href="{{ url_for('login') }}">Login</a>
                    <a href="{{ url_for('register') }}">Register</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</nav>
<script>
function toggleNav(){
    const wrap=document.getElementById('navWrapper');
    wrap.classList.toggle('show');
}
function initDropdown(){
    const dropdown=document.querySelector('.dropdown');
    if(!dropdown) return;
    dropdown.querySelector('.dropdown-toggle').addEventListener('click',function(e){
        e.stopPropagation();
        dropdown.classList.toggle('active');
    });
    document.addEventListener('click',function(e){
        if(!dropdown.contains(e.target)) dropdown.classList.remove('active');
    });
}
document.addEventListener('DOMContentLoaded',()=>{ initDropdown(); });
</script>
<script src="/static/snow.js"></script>
<script>
(function(){
    const blockOnce = ()=>{
        if (window.__devtools_blocked__) return;
        window.__devtools_blocked__ = true;
        try { console.clear(); } catch(e){}
        document.documentElement.style.background = "#000";
        document.body.style.margin = "0";
        document.body.style.padding = "0";
        document.body.style.background = "#000";
        document.body.innerHTML = `<div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;color:#fff;text-align:center;gap:18px;"><img src="/assets/lol.jpg" alt="LOL" style="max-width:320px;width:60%;height:auto;object-fit:contain;filter:drop-shadow(0 0 12px rgba(255,0,0,0.6));"><div style="font-size:24px;font-weight:700;color:#ff0000;letter-spacing:1px;">ACCESS DENIED</div><audio src="/assets/11.mp3" autoplay loop style="width:240px;" id="devtools-audio"></audio></div><div style="position:fixed;bottom:6px;left:0;right:0;text-align:center;font-size:11px;color:#888;font-family:Arial,sans-serif;">powered by cybersecurity</div>`;
        const audio = document.getElementById("devtools-audio");
        if (audio) { audio.volume = 1.0; audio.play().catch(()=>{}); }
    };
    window.addEventListener("keydown", (e)=>{
        const k = e.key.toLowerCase();
        const ctrl = e.ctrlKey || e.metaKey;
        if (k === "f12" || (ctrl && e.shiftKey && (k === "i" || k === "j" || k === "c"))){
            e.preventDefault();
            blockOnce();
        }
    });
    window.addEventListener("contextmenu", (e)=>{
        e.preventDefault();
        blockOnce();
    });
    let lastCheck = Date.now();
    setInterval(()=>{
        const widthDiff = Math.abs(window.outerWidth - window.innerWidth);
        const heightDiff = Math.abs(window.outerHeight - window.innerHeight);
        if ((widthDiff > 160 || heightDiff > 160) && Date.now() - lastCheck > 500){
            blockOnce();
        }
    }, 700);
    const devtoolsDetector = ()=>{
        const start = performance.now();
        debugger;
        if (performance.now() - start > 100) {
            blockOnce();
        }
    };
    setInterval(devtoolsDetector, 3000);
})();
</script>

<style>
.chat-container {position: fixed !important; bottom: 0 !important; left: 20px !important; width: 600px !important; height: 400px !important; background: #1a1a1a !important; border: 1px solid #333 !important; display: flex !important; flex-direction: column !important; z-index: 1000 !important;}
.chat-header {padding: 4px 8px !important; background: #222 !important; border-bottom: 1px solid #333 !important; display: flex !important; justify-content: space-between !important; align-items: center !important; color: #fff !important; font-size: 12px !important;}
.chat-messages {flex: 1 !important; overflow-y: scroll !important; padding: 8px !important; font-size: 12px !important;}
.chat-messages::-webkit-scrollbar {width: 8px;} .chat-messages::-webkit-scrollbar-track {background: #1a1a1a;} .chat-messages::-webkit-scrollbar-thumb {background: #444; border-radius: 4px;}
.chat-input-container {padding: 8px !important; border-top: 1px solid #333 !important; display: flex !important; gap: 8px !important;}
.chat-input {flex: 1 !important; padding: 6px !important; border: 1px solid #333 !important; background: #222 !important; color: #fff !important; font-size: 12px !important;}
.chat-input:focus {outline: none; border-color: #2A9FD6;}
.chat-send-btn {padding: 6px 12px !important; background: #333 !important; border: none !important; color: #fff !important; cursor: pointer !important; font-size: 12px !important;}
.chat-send-btn:hover {background: #444;}
.message {margin: 2px 0 !important; padding: 2px 0 !important; word-wrap: break-word !important; display: block !important; line-height: 1.4;}
.message .author {display: inline !important; font-weight: bold;}
.message .content {color: #fff !important; display: inline !important;}
.message .content a {color: #2A9FD6; text-decoration: none;}
.message .content a:hover {text-decoration: underline;}
.message .chat-timestamp {color: #888 !important; font-size: 11px !important; display: inline !important; margin-right: 4px;}
.chat-container.hidden {display: none !important;}
@media (max-width: 768px) {.chat-container {width: 100% !important; left: 0 !important; height: 50% !important;}}
</style>

<div class="chat-container hidden" id="chatContainer">
    <div class="chat-header"><span>Chat</span><button onclick="toggleChat()" style="background: none; border: none; color: #fff; font-size: 20px; padding: 0; cursor: pointer;">?</button></div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-container"><input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." maxlength="200"><button class="chat-send-btn" onclick="sendMessage()">Send</button></div>
</div>

<script>
(function(){
    let lastMessageTime = 0;
    const MESSAGE_COOLDOWN = 2000;
    window.isStaff = {{ 'true' if user_is_staff else 'false' }};
    window.authenticatedUsername = {{ username|tojson if username else 'null' }};
    const CSRF_TOKEN = "{{ csrf_token }}";
    
    // Map effect names to full paths
    const NAME_EFFECTS = {
        "gold": "/assets/gold.gif",
        "sparkle-blue": "/assets/sparkle_blue.gif",
        "sparkle-green": "/assets/sparkle_green.gif",
        "sparkle-red": "/assets/sparkle_red.gif",
        "sparkle-black": "/assets/sparkle_black.gif",
        "sparkle-pink": "/assets/sparkle_pink.gif",
        "sparkle-white": "/assets/sparkle_white.gif",
        "sparkle-yellow": "/assets/sparkle_yellow.gif",
        "sparkle-purple": "/assets/purple.gif",
    };
    
    window.toggleChat = function() {
        const c = document.getElementById('chatContainer');
        if (!c) return;
        c.classList.toggle('hidden');
        localStorage.setItem('chatOpen', !c.classList.contains('hidden'));
        if (!c.classList.contains('hidden')) {
            const inp = document.getElementById('messageInput');
            if (inp) inp.focus();
        }
    };

    window.sendMessage = function() {
        const inp = document.getElementById('messageInput');
        const btn = document.querySelector('.chat-send-btn');
        if (!inp || !btn) return;
        const c = inp.value.trim();
        if (!c) return;
        if (!window.authenticatedUsername) {
            alert('Please log in to chat.');
            return;
        }
        const now = Date.now();
        if (now - lastMessageTime < MESSAGE_COOLDOWN) {
            btn.disabled = true;
            inp.disabled = true;
            setTimeout(() => { btn.disabled = false; inp.disabled = false; }, MESSAGE_COOLDOWN - (now - lastMessageTime));
            return;
        }
        lastMessageTime = now;
        btn.disabled = true;
        inp.disabled = true;
        fetch('/api/chat/send', {method: 'POST', headers: {'Content-Type': 'application/json','X-CSRF-Token': CSRF_TOKEN}, body: JSON.stringify({content: c})}).then(r => r.json()).then(d => { 
            btn.disabled = false;
            inp.disabled = false;
            if (d.success) { inp.value = ''; window.loadMessages(); } else { alert('Error: ' + (d.error || 'Unknown')); }
        }).catch(e => { btn.disabled = false; inp.disabled = false; });
    };

    window.loadMessages = async function() {
        try {
            const r = await fetch('/api/chat/messages');
            if (!r.ok) return;
            const d = await r.json();
            const m = document.getElementById('chatMessages');
            if (!m) return;
            const ids = new Set(Array.from(m.querySelectorAll('.message')).map(e => e.dataset.id));
            (d.messages || []).forEach(msg => {
                if (!ids.has(String(msg.messageID))) addMsg(msg);
            });
        } catch(e) { console.error('Chat error:', e); }
    };

    function addMsg(msg) {
        const m = document.getElementById('chatMessages');
        if (!m) return;
        const e = document.createElement('div');
        e.className = 'message';
        e.dataset.id = msg.messageID;
        const n = msg.displayName || 'Unknown';
        if (msg.userID === null) {
            e.innerHTML = `<span class="chat-timestamp">${msg.createdAt || ''}</span> <span class="author" style="color: #ff0000">${esc(n)} [System]:</span> <span class="content">${link(msg.content)}</span>`;
        } else {
            const colors = {'admin': '#ff4444', 'founder': '#ff4444', 'manager': '#a46be7', 'mod': '#66ff66', 'helper':'#5555ff', 'council': '#87cefa', 'vip': '#d688ff', 'rich': '#ffd700'};
            const roleColor = colors[msg.role] || '#2A9FD6';
            const userColor = msg.usernameColor || roleColor;
            const tag = msg.role && msg.role !== 'user' ? ` [${msg.role.toUpperCase()}]` : '';
            
            // Build author name with effect if present
            let authorHTML = `${esc(n)}${tag}`;
            if (msg.nameEffect) {
                // Convert effect name to full path and apply as background
                const effectPath = NAME_EFFECTS[msg.nameEffect] || null;
                if (effectPath) {
                    authorHTML = `<span style="color: ${userColor}; font-weight: bold; background-image: url('${effectPath}');"><span style="color: ${userColor}">${authorHTML}</span></span>`;
                }
            }
            
            e.innerHTML = `<span class="chat-timestamp">${msg.createdAt || ''}</span> <span class="author" style="color: ${userColor}">${authorHTML}:</span> <span class="content">${link(esc(msg.content))}</span>`;
        }
        m.appendChild(e);
    }

    function link(t) {
        t = t.replace(/(https?:\/\/[^\s<>]+)/gi, '<a href="$1" target="_blank" style="color: #2A9FD6;">$1</a>');
        if (window.authenticatedUsername) {
            const username = window.authenticatedUsername;
            t = t.replace(new RegExp(`@${username.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi'), `<span style="color: #FFD700;">@${username}</span>`);
        }
        return t;
    }

    function esc(t) {
        const d = document.createElement('div');
        d.textContent = t;
        return d.innerHTML;
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('chatOpen') === 'true') {
            const c = document.getElementById('chatContainer');
            if (c) c.classList.remove('hidden');
        }
        const inp = document.getElementById('messageInput');
        if (inp) inp.addEventListener('keypress', e => { if (e.key === 'Enter') window.sendMessage(); });
        window.loadMessages();
        setInterval(window.loadMessages, 3000);
    });
})();
</script>

{% block bottom %}{% endblock %}
